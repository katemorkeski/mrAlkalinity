---
title: "mississippi-data-assembly"
author: "Kate Morkeski"
date: "`r Sys.Date()`"
output: html_document
---
## Setup

Libraries used

```{r}

library(here)
library(readxl)
library(tidyverse)
library(geosphere)
library(lubridate)
library(stats)

```
## May cruise

# Read in CTD and bottle data

```{r}
compiled <- read_excel(here('MSR_1_Compiled.xlsx')) 
#salinity <- read_excel(here('MSR_1_Salinity.xlsx'))
```

# Format date and time

```{r}

compiled <- compiled %>%
  rename(time_utc = "Time (UTC)") %>%
  rename(station = Station_ID) %>%
  rename(cast = Cast_number) %>%
  rename(niskin = Niskin_ID) %>%
  rename(lat = "Latitude [decimal degrees]") %>%
  rename(long = "Longitude [decimal degrees]") %>%
  rename(temperature = "CTD_Potential_Temp [deg_C]") %>%
  rename(depth_m = "Depth [m]")

# combine date and time
compiled$Date <- as.character(compiled$Date) 
compiled$time_utc <- as.character(compiled$time_utc)
compiled$time_utc <- gsub("1899-12-31 ", "", compiled$time_utc)
compiled$date_time_utc <- paste(compiled$Date, compiled$time_utc)
compiled$date_time_utc <- as.POSIXct(compiled$date_time_utc, tz = "UTC", format="%Y-%m-%d %H:%M:%OS")

compiled <- compiled %>% relocate(date_time_utc, .before = station)

```

# Correct apparent error in Station 6 coordinate

```{r}

# cast 6, niskin 6 entered with lat/long identical to station 7 entries
compiled <- compiled %>% 
  mutate(lat = replace(lat, station == 6 & niskin == 6, 29.35218)) %>%
  mutate(long = replace(long, station == 6 & niskin == 6, -89.46450))  


```

# Create map

```{r}

# very generic state boundary
# need more detailed map data
us_map <- map_data("state")

louisiana <- us_map %>% 
  filter(region %in% "louisiana") 

mouth <- louisiana %>% filter(long > -91.5 & lat < 30.5)

mapping <- compiled %>% 
  select(date_time_utc, station, cast, niskin, lat, long, temperature, depth_m, CTDSAL_PSS78) 

ggplot(louisiana, aes(x = long, y = lat)) +
  geom_path() +
  geom_point(data = mapping, aes(x = long, y = lat, color = CTDSAL_PSS78)) +  
  theme_minimal()

ggplot(louisiana, aes(x = long, y = lat)) +
  geom_path() +
  geom_point(data = mapping, aes(x = long, y = lat, color = station)) +  
  theme_minimal()  

ggplot(mouth, aes(x = long, y = lat)) +
  geom_path() +
  geom_point(data = mapping, aes(x = long, y = lat, color = CTDSAL_PSS78)) +  
  theme_minimal()

ggplot(mouth, aes(x = long, y = lat)) +
  geom_path() +
  geom_text(data = mapping, aes(x = long, y = lat, label = station)) +  
  theme_minimal()

ggplot(mouth, aes(x = long, y = lat)) +
  geom_path() +
  geom_text(data = mapping, aes(x = long, y = lat, label = station), size = 3) +  
  coord_fixed(xlim = c(-90.0, -89.25), ylim = c(28.5, 29.25))+
  theme_minimal()

ggplot(mouth, aes(x = long, y = lat)) +
  geom_path() +
  geom_path(data = mapping, aes(x = long, y = lat, color = CTDSAL_PSS78)) +  
  coord_fixed(xlim = c(-90.0, -89.25), ylim = c(28.5, 29.25))+
  theme_minimal()

```

# Label stations

```{r}
# mapping <- mapping %>%
#   mutate(leg = case_when(station <10 ~ "river",
#                          station == 10 ~ "gulf",
#                          station > 14 ~ "gulf",
#                          TRUE ~ "spur"))

# identify surface rows
mapping <-mapping %>% 
  mutate(surface = case_when(station < 15 & depth_m < 3 ~ "Y",
                             station > 14 & depth_m < 2 ~ "Y",
                             TRUE ~ "N"
  )) 

surface_bottles <-mapping %>% filter(surface == "Y")

surface_bottles <- surface_bottles %>% select(-surface)

```


# Towards join with GO data

```{r}
# read in GO data
GOfiles <- dir(here("MSR_GO_data_May/"), "*.txt") # get file names

GO_May <- GOfiles %>% map_dfr(~ read_tsv(here("MSR_GO_data_May/", .), show_col_types = FALSE, ))

```

```{r}
# handle date and time columns
GO_May <- rename(GO_May, PC_Date = "PC Date")
GO_May <- rename(GO_May, PC_Time = "PC Time")

# combine date and time
GO_May$PC_Date <- as.character(GO_May$PC_Date) 
GO_May$PC_Time <- as.character(GO_May$PC_Time) 
GO_May$date_time_utc <- paste(GO_May$PC_Date, GO_May$PC_Time)
GO_May$date_time_utc <- as.POSIXct(GO_May$date_time_utc, tz = "UTC", format="%d/%m/%y %H:%M:%OS")

# GO system clock was likely not set at start of deployment, so recorded time should be considered approximately but not exactly UTC

```
# Match bottle data by time

```{r}

# match bottle data to GO data based on datetime
# get lat, long, T, S from bottle data

for (i in 1:nrow(surface_bottles)) {
  
  surface_bottles$GO_row[i] <- which.min(abs(GO_May$date_time_utc - surface_bottles$date_time_utc[i]))
  
}

# for surface bottles, average temperature, depth, and salinity by station and cast
# retain lat, long, and GO_row
surface_avgs <- surface_bottles %>% 
  group_by(station, cast) %>%
  summarize(lat = mean(lat),
            long = mean(long), 
            temperature = mean(temperature),
            depth_m = mean(depth_m),
            CTDSAL_PSS78 = mean(CTDSAL_PSS78),
            GO_row = mean(GO_row))

# round GO_row to integer
surface_avgs$GO_row <- round(surface_avgs$GO_row, 0)

GO_May$GO_row <- seq.int(nrow(GO_May))

GOplus <- left_join(GO_May, surface_avgs, by = "GO_row")

# check which bottle rows are used
ctd_check <- GOplus %>% 
  filter(!is.na(station))

```

# Label records collected prior to entering the river

```{r}

#Based on GO log sheets, river data begin after 11:35 local time, 2022-05-10 16:37:37 UTC, which is 1652200657 in numeric format
GOplus$date_time_num <- as.numeric(GOplus$date_time_utc)

GOplus <- GOplus %>%
  mutate(leg = case_when(date_time_num < 1652200657 ~ "transit"))

```

# Export file for pCO2sys processing

```{r}

# remove records before river
GO_out <- GOplus %>% filter(is.na(leg))

# remove unneeded columns
GO_out <- GO_out %>% select(-GO_row, -date_time_num, -leg)

# replace NAs with -999 for Matlab
GO_out <- GO_out %>% mutate(station = case_when(is.na(station) ~ -999, TRUE ~ station)) %>% 
  mutate(cast = case_when(is.na(cast) ~ -999, TRUE ~ cast)) %>% 
  mutate(lat = case_when(is.na(lat) ~ -999, TRUE ~ lat)) %>% 
  mutate(long = case_when(is.na(long) ~ -999, TRUE ~ long)) %>% 
  mutate(temperature = case_when(is.na(temperature) ~ -999, TRUE ~ temperature)) %>% 
  mutate(depth_m = case_when(is.na(depth_m) ~ -999, TRUE ~ depth_m)) %>% 
  mutate(CTDSAL_PSS78 = case_when(is.na(CTDSAL_PSS78) ~ -999, TRUE ~ CTDSAL_PSS78) )

GO_out <- GO_out %>% 
  filter(Type != "SHUT DOWN") 

# write csv
write.csv(GO_out, here('GO_Mississippi_May.csv'), row.names = FALSE)

```
# Read in met data

```{r}

GO_out <- read_csv('GO_Mississippi_May.csv')

#https://mesonet.agron.iastate.edu/request/download.phtml?network=LA_ASOS
# one site is MSY airport and the other Is a rig/platform south of the estuary (named DSF). 

MSY_met <- read.csv("MSY_Met.csv")
rig_met <- read.csv("MSR_Met_Data.csv")

MSY_met <- rename(MSY_met, datetime = valid)

# set time zone 
MSY_met$datetime <- strptime(MSY_met$datetime,"%m/%d/%Y %R")
rig_met$datetime <- strptime(rig_met$datetime,"%m/%d/%Y %R")
tz(MSY_met$datetime) <- "America/New_York"
tz(rig_met$datetime) <- "America/New_York"

rig_met$alti <- as.numeric(rig_met$alti)
MSY_met$mslp <- as.numeric(MSY_met$mslp)

GO_out <- rename(GO_out, equ_press = "equ press")
GO_out$equ_press <- as.numeric(GO_out$equ_press)
GO_out <- rename(GO_out, licor_press = "licor press")
GO_out$licor_press <- as.numeric(GO_out$licor_press)
GO_out$equ_calc <- GO_out$equ_press + GO_out$licor_press

# need POSIXct for graphing together
MSY_met$datetime <- as.POSIXct(MSY_met$datetime)
rig_met$datetime <- as.POSIXct(rig_met$datetime)

# format wind speed for plotting
MSY_met <- rename(MSY_met, speed_mph = "speed..mph.")
MSY_met$speed_mph <- replace(MSY_met$speed_mph, MSY_met$speed_mph == "M", NA)
MSY_met$speed_mph <- as.numeric(MSY_met$speed_mph)

rig_met <- rename(rig_met, speed_mph = "speed..mph.")
rig_met$speed_mph <- replace(rig_met$speed_mph, rig_met$speed_mph == "M", NA)
rig_met$speed_mph <- as.numeric(rig_met$speed_mph)

# isolate dates of May cruise
May_MSY_met <- MSY_met %>% filter(month(datetime) == 5)
May_MSY_met <- May_MSY_met %>% filter(day(datetime) > 9 & day(datetime) < 13 ) 
May_rig_met <- rig_met %>% filter(month(datetime) == 5)
May_rig_met <- May_rig_met %>% filter(day(datetime) > 9 & day(datetime) < 13 ) 

# isolate dates of Oct cruise
Oct_MSY_met <- MSY_met %>% filter(month(datetime) == 10)
Oct_MSY_met <- Oct_MSY_met %>% filter(day(datetime) > 11 & day(datetime) < 14 ) 
Oct_rig_met <- rig_met %>% filter(month(datetime) == 10)
Oct_rig_met <- Oct_rig_met %>% filter(day(datetime) > 11 & day(datetime) < 14 ) 

# create data frame to plot met stations relative to cruise stations
station <- c(MSY_met$station[1], rig_met$station[1])
long = c(MSY_met$lon[1], rig_met$lon[1])
lat = c(MSY_met$lat[1], rig_met$lat[1])
met_stns <- data.frame(station, long, lat)

```
# plot met data

```{r}

# plot 2022 pressure data from both sites
ggplot(MSY_met, aes(x = datetime, y = alti, color = "MSY")) +
  geom_point() +
  geom_point(data = rig_met, aes(x = datetime, y = alti, color = "rig")) + 
  theme_minimal()

# plot 2022 wind data from both sites
ggplot(MSY_met, aes(x = datetime, y = speed_mph, color = "MSY")) +
  geom_point() +
  geom_point(data = rig_met, aes(x = datetime, y = speed_mph, color = "rig")) + 
  theme_minimal()

# plot pressure data from May cruise dates
# alti
ggplot(May_MSY_met, aes(x = datetime, y = alti, color = "MSY")) +
  geom_point() +
  geom_point(data = May_rig_met, aes(x = datetime, y = alti, color = "rig")) + 
  theme_minimal()
# mslp
ggplot(May_MSY_met, aes(x = datetime, y = mslp, color = "MSY")) +
  geom_point() +
  theme_minimal()
# mslp and equ pressure
scale = 1
ggplot(May_MSY_met, aes(x = datetime, y = mslp, color = "MSY")) +
  geom_point() +
  geom_point(data = GO_out, aes(x = date_time_utc, y = equ_calc, color = "equ")) +
  scale_y_continuous(limits = c(1012, 1024), sec.axis = sec_axis(~.*scale, name="mslp")) +
  theme_minimal()

# MSY alti and mslp
scale = 34
ggplot(May_MSY_met, aes(x = datetime, y = alti)) +
  geom_point(aes(color = "MSY alti")) +
  geom_point(aes(y = mslp/34, color = "MSY mslp")) + 
  scale_y_continuous(limits = c(29.8, 30.2), sec.axis = sec_axis(~.*scale, name="mslp")) +
  labs(x = "Date and Time", y = "alti", color = "") +
  theme_minimal()

ggplot(Oct_MSY_met, aes(x = datetime, y = alti)) +
  geom_point(aes(color = "MSY alti")) +
  geom_point(aes(y = mslp/34, color = "MSY mslp")) + 
  scale_y_continuous(limits = c(29.7, 30.1), sec.axis = sec_axis(~.*scale, name="mslp")) +
  labs(x = "Date and Time", y = "alti", color = "") +
  theme_minimal()

# plot pressure data from Oct cruise dates
# alti
ggplot(Oct_MSY_met, aes(x = datetime, y = alti, color = "MSY")) +
  geom_point() +
  geom_point(data = Oct_rig_met, aes(x = datetime, y = alti, color = "rig")) + 
  theme_minimal()
# mslp
ggplot(Oct_MSY_met, aes(x = datetime, y = mslp, color = "MSY")) +
  geom_point() +
  theme_minimal()

# plot locations of met stations
ggplot(mouth, aes(x = long, y = lat)) +
  geom_path() +
  geom_text(data = mapping, aes(x = long, y = lat, label = station)) +  
  geom_text(data = met_stns, aes(x = long, y = lat, label = station))+
  theme_minimal()  

```
# Convert alti from inches Hg to mbar
```{r}

# multiply alti by 33.8639 to convert from inches Hg to mbar
May_MSY_met <- May_MSY_met %>%
  mutate(Patm = alti*33.8639)

May_rig_met <- May_rig_met %>%
  mutate(Patm = alti*33.8639)

Oct_MSY_met <- Oct_MSY_met %>%
  mutate(Patm = alti*33.8639)

Oct_rig_met <- Oct_rig_met %>%
  mutate(Patm = alti*33.8639)

# plot pressure data 
ggplot(May_MSY_met, aes(x = datetime, y = Patm, color = "MSY")) +
  geom_point() + 
  geom_point(data = May_rig_met, aes(x = datetime, y = Patm, color = "rig")) + 
  theme_minimal()

ggplot(Oct_MSY_met, aes(x = datetime, y = Patm, color = "MSY")) +
  geom_point() + 
  geom_point(data = Oct_rig_met, aes(x = datetime, y = Patm, color = "rig")) + 
  theme_minimal()

```
# Interpolate met data and average across MSY and DSF stations

```{r}
# May
May_MSY_Patm <- data.frame(approx(May_MSY_met$datetime, May_MSY_met$Patm, xout = May_rig_met$datetime, rule = 2, method = "linear"))

May_rig_Patm <- May_rig_met %>% select(datetime, Patm)

May_Patm <- cbind(May_MSY_Patm, May_rig_Patm)
May_Patm <- May_Patm %>% 
  rename(Patm_MSY = y) %>% 
  rename(Patm_rig = Patm) 

May_Patm <- May_Patm %>%
  mutate(Patm_avg = (Patm_MSY + Patm_rig)/2)

ggplot(May_Patm, aes(x = datetime, y = Patm_MSY, color = "MSY")) +
  geom_point() + 
  geom_point(data = May_Patm, aes(x = datetime, y = Patm_rig, color = "rig")) + 
  geom_point(data = May_Patm, aes(x = datetime, y = Patm_avg, color = "avg")) + 
  theme_minimal()

ggplot(May_MSY_met, aes(x = datetime, y = Patm, color = "MSY")) +
  geom_point() + 
  geom_point(data = May_rig_met, aes(x = datetime, y = Patm, color = "rig")) + 
  theme_minimal()

```


```{r}

# interpolate atmospheric pressure to GO data time stamps

# read in GO file partially processed with pCO2sys
GO <- read.csv("MAY_lat_long_temp_sal_Tin_air_Working.csv")
GO$date_time_utc <- as.POSIXct(GO$date_time_utc, format= "%Y-%m-%d %H:%M:%S")

GO_Patm <- data.frame(approx(May_Patm$datetime, May_Patm$Patm_avg, xout = GO$date_time_utc, rule = 2, method = "linear"))

GO <- cbind(GO, GO_Patm)

ggplot(GO, aes(x = x, y = y, color = "Patm")) +
  geom_point() + 
  geom_point(data = GO, aes(x = date_time_utc, y = licor.press, color = "Plicor")) + 
  theme_minimal()

GO <- GO %>% 
  select(-x) %>%
  rename(Patm = y)  

#write file for further processing
#write.csv(GO, here('MAY_lat_long_temp_sal_Tin_air_Working_Patm.csv'), row.names = FALSE)
#if this step already done, read in above file

```
# Convert wind speed units and interpolate wind speed

```{r}

# May
May_MSY_wind <- data.frame(approx(May_MSY_met$datetime, May_MSY_met$speed_mph, xout = May_rig_met$datetime, rule = 2, method = "linear"))

May_rig_wind <- May_rig_met %>% select(datetime, speed_mph)

May_wind <- cbind(May_MSY_wind, May_rig_wind)
May_wind <- May_wind %>% 
  rename(speed_mph_MSY = y) %>% 
  rename(speed_mph_rig = speed_mph) 

# convert mph to m/s
May_wind$speed_m_s_MSY <- May_wind$speed_mph_MSY*0.44704
May_wind$speed_m_s_rig <- May_wind$speed_mph_rig*0.44704

# interpolate to GO timestamps
GO_May_wind_MSY <- data.frame(approx(May_wind$datetime, May_wind$speed_m_s_MSY, xout = GO$date_time_utc, rule = 2, method = "linear"))
GO_May_wind_rig <- data.frame(approx(May_wind$datetime, May_wind$speed_m_s_rig, xout = GO$date_time_utc, rule = 2, method = "linear"))

GO_May_wind_MSY <- GO_May_wind_MSY %>%
  rename(date_time_utc_MSY = x) %>%
  rename(wind_m_s_MSY = y)

GO_May_wind_rig <- GO_May_wind_rig %>%
  rename(date_time_utc_rig = x) %>%
  rename(wind_m_s_rig = y)

GO_May_wind <- cbind(GO_May_wind_MSY, GO_May_wind_rig)

GO_May_wind <- GO_May_wind %>%
  select(-date_time_utc_rig) %>%
  rename(date_time_utc = date_time_utc_MSY)

# output csv
write.csv(GO_May_wind, "GO_May_wind_interp.csv", row.names = FALSE)

# plot
# wind with MSY timestamp
ggplot(May_wind, aes(x = datetime, y = speed_m_s_MSY, color = "MSY")) +
  labs(x = "datetime", y = "MSY wind mph") +
  geom_point() + 
  geom_point(data = May_wind, aes(x = datetime, y = speed_m_s_rig, color = "rig")) + 
  labs(x = "datetime", y = "wind m/s") +
    theme_minimal()

# wind interpolated to GO timestamps
ggplot(GO_May_wind, aes(x = date_time_utc, y = wind_m_s_MSY, color = "MSY")) +
  labs(x = "datetime", y = "MSY wind mph") +
  geom_point() + 
  geom_point(data = GO_May_wind, aes(x = date_time_utc, y = wind_m_s_rig, color = "rig")) + 
  labs(x = "datetime", y = "wind m/s") +
    theme_minimal()

```
############################################## Plotting 
# read in processed GO data for plotting

```{r}

GO <- read.csv("MAY_lat_long_temp_sal_Tin_air_Working.csv")

# Isolate data from equilibrator

GOplus <- GOplus %>% rename(CO2_ppm = "CO2 um/m")

GO_EQU_plus <- GOplus %>% filter(Type == "EQU" | Type == "EQU-DRAIN")

```
# Calculate cruise distance

```{r}

GOplus_coord <- GOplus %>% filter(!is.na(long) & !is.na(lat) )

for (i in 1:nrow(GOplus_coord)) {
  df_lon <- GOplus_coord$long[i]
  df_lat <- GOplus_coord$lat[i]
  GOplus_coord$cruise_dist_km <- as.integer(NA)
  {
    df_lon_lat <- c(df_lon,df_lat)
    km_cruise[i] <- distHaversine(c(-89.9587,29.90158), df_lon_lat, r=6378.137)
  }
  GOplus_coord$cruise_dist_km <- km_cruise
  
}

GOplus_coord_EQU <- GOplus_coord %>% filter(Type == "EQU" | Type == "EQU-DRAIN")

# for (i in 1:nrow(GOplus)) {
#   df_lon <- GOplus$long[i]
#   df_lat <- GOplus$lat[i]
#   GOplus$cruise_dist_km <- as.integer(NA)
#  
#   if (is.na(df_lon) & is.na(df_lat)) 
#     {next}
#   else
#   
#   if (!is.na(df_lon) & !is.na(df_lat)) 
#     {
#     df_lon_lat <- c(df_lon,df_lat)
#     km_cruise[i] <- distHaversine(c(-89.9587,29.90158), df_lon_lat, r=6378.137)}
#     
#    GOplus$cruise_dist_km <- km_cruise
# }


ggplot(GOplus_coord_EQU, aes(x = lat, y = CO2_ppm))+
  geom_point()+
  theme_minimal()

ggplot(GOplus_coord_EQU, aes(x = cruise_dist_km, y = CO2_ppm))+
  geom_point()+
  theme_minimal()

```
# Plot all GO EQU data

```{r}

ggplot(mouth, aes(x = long, y = lat)) +
  geom_path() +
  geom_point(data = GO_EQU_plus, aes(x = long, y = lat, color = CO2_ppm)) + 
  scale_color_gradient(low="orange", high="darkred") +
  theme_minimal()  

ggplot(GO_EQU_plus, aes(x = date_time_utc.x, y = CO2_ppm, color = leg))+
  geom_point()+
  scale_color_manual(values = c("black", "darkturquoise", "chartreuse3", "yellow", "gray50"))+
  theme_minimal()

ggplot(GO_EQU_plus, aes(x = date_time_utc.y, y = CO2_ppm, color = leg))+
  geom_point()+
  scale_color_manual(values = c("black", "darkturquoise", "chartreuse3", "yellow", "gray50"))+
  theme_minimal()


```

```{r}

#GO_EQU_cruise <- GO_EQU_plus %>% filter(leg != "transit")

```

# Plot data with pre-river data excluded

```{r}

# ggplot(mouth, aes(x = long, y = lat)) +
#   geom_path() +
#   geom_point(data = GO_EQU_cruise, aes(x = long, y = lat, color = CO2_ppm)) + 
#   scale_color_gradient(low="orange", high="darkred") +
#   theme_minimal()  
# 
# ggplot(GO_EQU_cruise, aes(x = date_time_utc.x, y = CO2_ppm, color = leg))+
#   geom_point()+
#   scale_color_manual(values = c("gray50", "darkturquoise", "chartreuse3", "yellow"))+
#   theme_minimal()
# 
# ggplot(GO_EQU_cruise, aes(x = date_time_utc.y, y = CO2_ppm, color = leg))+
#   geom_point()+
#   scale_color_manual(values = c("gray50", "darkturquoise", "chartreuse3", "yellow"))+
#   theme_minimal()
# 
# ggplot(GO_EQU_cruise, aes(x = date_time_utc.x, y = temperature, color = leg))+
#   geom_point()+
#   scale_color_manual(values = c("gray50", "darkturquoise", "chartreuse3", "yellow"))+
#   theme_minimal()
# 
# ggplot(GO_EQU_cruise, aes(x = date_time_utc.x, y = CTDSAL_PSS78, color = leg))+
#   geom_point()+
#   scale_color_manual(values = c("gray50", "darkturquoise", "chartreuse3", "yellow"))+
#   theme_minimal()
# 
# ggplot(GO_EQU_cruise, aes(x = lat, y = CO2_ppm, color = leg))+
#   geom_point()+
#   scale_color_manual(values = c("gray50", "darkturquoise", "chartreuse3", "yellow"))+
#   theme_minimal()


```

# Export file for GO processing

```{r}

# GO_out <- GOplus %>% 
#   rename("CO2 um/m" = CO2_ppm) %>%
#   rename(date_time_utc = date_time_utc.x) %>%
#   select(-ind, -bottlerow, -date_time_utc.y, -row_num, -date_time_num, -time_diff, -time_diff_num, -time_diff_min, -time_diff_hrs)
# 
# write.csv(GO_out, here('GO_Mississippi_May.csv'), row.names = FALSE)
# 
# GO_out <- GO_out %>% filter(leg != "transit") %>%
#                     filter(leg != "> 1 hr from station")
# 
# write.csv(GO_out, here('GO_Mississippi_May_near_stations.csv'), row.names = FALSE)

```



```{r}

# combine station and cast later

GOplus <- GOplus %>% filter(leg != "transit") 

GOplus <- GOplus %>% 
  group_by(station, cast, niskin) %>%
  mutate(min_time_diff = min(time_diff_num)) %>%
  ungroup()

closest_niskin <- GOplus %>% 
  group_by(station, cast, niskin) %>%
  summarize(min(time_diff_num)) 

GOplus$nearest_niskin <- NA_integer_

GOplus <- GOplus %>%
  mutate(nearest_niskin = case_when(time_diff_num == min_time_diff ~ niskin))

GOplus <- GOplus %>% 
  rename(date_time_utc = date_time_utc.x) %>%
  select(-niskin, -ind, -bottlerow, -date_time_utc.y, -row_num, -date_time_num, -time_diff, -time_diff_num, -time_diff_min, -time_diff_hrs, -min_time_diff)

# remove CTD parameters for non-niskin locations
GOplus$date_time_utc <- replace(GOplus$date_time_utc, is.na(GOplus$nearest_niskin), NA)
GOplus$station <- replace(GOplus$station, is.na(GOplus$nearest_niskin), NA)
GOplus$cast <- replace(GOplus$cast, is.na(GOplus$nearest_niskin), NA)
GOplus$lat <- replace(GOplus$lat, is.na(GOplus$nearest_niskin), NA)
GOplus$long <- replace(GOplus$long, is.na(GOplus$nearest_niskin), NA)
GOplus$temperature <- replace(GOplus$temperature, is.na(GOplus$nearest_niskin), NA)
GOplus$depth_m <- replace(GOplus$depth_m, is.na(GOplus$nearest_niskin), NA)
GOplus$CTDSAL_PSS78 <- replace(GOplus$CTDSAL_PSS78, is.na(GOplus$nearest_niskin), NA)
GOplus$leg <- replace(GOplus$leg, is.na(GOplus$nearest_niskin), NA)

# Check distribution of depth
hist(GOplus$depth_m)

# check relationship of temperature with depth
ggplot(GOplus, aes(x = depth_m, y = temperature, color = leg))+
  geom_point()+
  theme_minimal()
# temperature more strongly controlled by habitat than by depth

GO_out <- GOplus %>% 
  rename("CO2 um/m" = CO2_ppm)

# replace NAs with -999 for Matlab
GO_out <- GO_out %>% mutate(station = case_when(is.na(station) ~ -999, TRUE ~ station)) %>% 
  mutate(cast = case_when(is.na(cast) ~ -999, TRUE ~ cast)) %>% 
  mutate(lat = case_when(is.na(lat) ~ -999, TRUE ~ lat)) %>% 
  mutate(long = case_when(is.na(long) ~ -999, TRUE ~ long)) %>% 
  mutate(temperature = case_when(is.na(temperature) ~ -999, TRUE ~ temperature)) %>% 
  mutate(depth_m = case_when(is.na(depth_m) ~ -999, TRUE ~ depth_m)) %>% 
  mutate(CTDSAL_PSS78 = case_when(is.na(CTDSAL_PSS78) ~ -999, TRUE ~ CTDSAL_PSS78) )

GO_out <- GO_out %>% 
  filter(Type != "SHUT DOWN") 

#write.csv(GO_out, here('GO_Mississippi_May.csv'), row.names = FALSE)

```


```{r}
# read in data processed with pCO2 Sys

xCO2 <- read.csv(here('MSP_20220510_Working_inter_stds.csv'))

xCO2_EQU <- xCO2 %>% 
  filter(Type == "EQU") 

# convert -999 to NA  
xCO2_EQU <- na_if(xCO2_EQU, "-999")

# calculate difference between corrected and raw CO2
xCO2_EQU <- xCO2_EQU %>%
  mutate(xdiff = xCO2.corr - CO2.um.m)


```

```{r}

ggplot(xCO2_EQU, aes(x = YDay.Calc, y = xCO2.corr, color = "corrected xCO2"))+
  geom_point()+
  geom_point(aes(x = YDay.Calc, y = CO2.um.m, color = "raw CO2 um/m")) +
  theme_minimal()

ggplot(xCO2_EQU, aes(x = YDay.Calc, y = xdiff)) + geom_point()+theme_minimal()

ggplot(mouth, aes(x = long, y = lat)) +
  geom_path() +
  geom_point(data = xCO2_EQU, aes(x = long, y = lat, color = CO2.um.m)) + 
  scale_color_gradient(low="orange", high="darkred") +
  theme_minimal() 


ggplot(mouth, aes(x = long, y = lat)) +
  geom_path() +
  geom_point(data = xCO2_EQU, aes(x = long, y = lat, color = xCO2.corr)) + 
  scale_color_gradient(low="orange", high="darkred") +
  theme_minimal()

```


